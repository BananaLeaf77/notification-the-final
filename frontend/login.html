<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System Dashboard</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <!-- Login Section -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header text-center">
                        <h4>Login</h4>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input type="text" id="username" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input type="password" id="password" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Login</button>
                        </form>
                        <div id="loginMessage" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Section -->
        <div id="actions" class="d-none">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <button id="getStudents" class="btn btn-info btn-block">Get All Students</button>
                </div>
                <div class="col-md-6 mb-4">
                    <button id="downloadTemplate" class="btn btn-success btn-block">Download Input Template</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <button id="getTruancyHistory" class="btn btn-warning btn-block">Get Truancy History</button>
                </div>
                <div class="col-md-6 mb-4">
                    <form id="massNotificationForm">
                        <div class="form-group">
                            <label for="notificationIDs">Enter Student IDs (comma-separated)</label>
                            <input type="text" id="notificationIDs" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-danger btn-block">Send Mass Notification</button>
                    </form>
                </div>
            </div>
            <div id="actionMessage" class="mt-3"></div>
        </div>
    </div>

    <script>
        let authToken = '';

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const response = await fetch('http://127.0.0.1:8000/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            const result = await response.json();
            const loginMessage = document.getElementById('loginMessage');

            if (response.ok) {
                authToken = result.Token;
                loginMessage.innerHTML = '<div class="alert alert-success">Login successful! Role: ' + result.Role + '</div>';
                document.getElementById('actions').classList.remove('d-none');
            } else {
                loginMessage.innerHTML = '<div class="alert alert-danger">' + result.error + '</div>';
            }
        });

        document.getElementById('getStudents').addEventListener('click', async function() {
            const response = await fetch('http://127.0.0.1:8000/student/get-all', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            const result = await response.json();
            const actionMessage = document.getElementById('actionMessage');

            if (response.ok) {
                actionMessage.innerHTML = '<div class="alert alert-info">Students: ' + JSON.stringify(result.data) + '</div>';
            } else {
                actionMessage.innerHTML = '<div class="alert alert-danger">Failed to fetch students</div>';
            }
        });

        document.getElementById('downloadTemplate').addEventListener('click', function() {
            const url = 'http://127.0.0.1:8000/student/download_input_template';
            const headers = new Headers();
            headers.append('Authorization', `Bearer ${authToken}`);

            fetch(url, { method: 'GET', headers })
                .then(response => response.blob())
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = 'input_data_template.csv';
                    link.click();
                })
                .catch(() => {
                    document.getElementById('actionMessage').innerHTML = '<div class="alert alert-danger">Failed to download template</div>';
                });
        });

        document.getElementById('massNotificationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const ids = document.getElementById('notificationIDs').value.split(',').map(Number);
            const response = await fetch('http://127.0.0.1:8000/sender/send-mass', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ ids })
            });

            const result = await response.json();
            const actionMessage = document.getElementById('actionMessage');

            if (response.ok) {
                actionMessage.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
            } else {
                actionMessage.innerHTML = '<div class="alert alert-danger">' + result.error + '</div>';
            }
        });

        document.getElementById('getTruancyHistory').addEventListener('click', async function() {
            const response = await fetch('http://127.0.0.1:8000/notification/truancy-history', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            const result = await response.json();
            const actionMessage = document.getElementById('actionMessage');

            if (response.ok) {
                actionMessage.innerHTML = '<div class="alert alert-info">Truancy History: ' + JSON.stringify(result.data) + '</div>';
            } else {
                actionMessage.innerHTML = '<div class="alert alert-danger">Failed to fetch truancy history</div>';
            }
        });
    </script>
</body>
</html>
